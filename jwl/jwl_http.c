/* Generated by re2c 1.3 on Fri Jul 24 00:18:03 2020 */
#line 1 "jwl/jwl_http.l"
/* Copyright (c) [2019] juruoyun developer team
   Juruoyun web lib is licensed under the Mulan PSL v1.
   You can use this software according to the terms and conditions of the Mulan PSL v1.
   You may obtain a copy of Mulan PSL v1 at:
      http://license.coscl.org.cn/MulanPSL
   THIS SOFTWARE IS PROVIDED ON AN "AS IS" BASIS, WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO NON-INFRINGEMENT, MERCHANTABILITY OR FIT FOR A PARTICULAR
   PURPOSE.
   See the Mulan PSL v1 for more details.*/
#include "jwl_http.h"
#if JWL_HTTP_ENABLE==1
jwl_http_resh *jwl_http_resh_new()
{
	return jwl_http_resh_init(jbl_malloc(sizeof(jwl_http_resh)));
}
jwl_http_resh *jwl_http_resh_init(jwl_http_resh * this)
{
	if(!this)jbl_exception("NULL POINTER");		
	jbl_gc_init(this);
	jbl_gc_plus(this);
	this->status		=0;
	this->cache			=0;
	this->cache_max_age	=0;	
	this->charset	=0;	
	this->content_type	=NULL;
	this->etag			=NULL;
	this->v				=NULL;
	return this;
}
jwl_http_resh *jwl_http_resh_free(jwl_http_resh * this)
{
	if(!this)return NULL;
	jbl_gc_minus(this);
	if(!jbl_gc_refcnt(this))
	{
		if(jbl_gc_is_ref(this))
			jwl_http_resh_free((jwl_http_resh *)jbl_refer_pull(this));
		else
		{
			this->content_type	=jbl_string_free(this->content_type);
			this->etag			=jbl_string_free(this->etag);
			this->v				=jbl_ht_free	(this->v);
		}
		if(jbl_gc_is_var(this))//因为该功能依赖jbl_ht,jbl_ht强制依赖var所以不用宏判断
			jbl_free((char*)this-sizeof(jbl_var));
		else
			jbl_free(this);
	}
	return NULL;	
	
}
inline jwl_http_resh *jwl_http_resh_copy(jwl_http_resh * this)
{
	jbl_gc_plus(this);
	return this;
}
inline jwl_http_resh *jwl_http_resh_extend(jwl_http_resh * this,jwl_http_resh **pthi)
{
	if(!this){this=jwl_http_resh_new();if(pthi)*pthi=this;return this;}
	jbl_reference *ref=NULL;jwl_http_resh *thi=jbl_refer_pull_keep_father(this,&ref);
	if(jbl_gc_is_pvar(thi))
	{
		jwl_http_resh *ttt=((jbl_reference*)thi)->ptr;
		if(jbl_gc_refcnt(thi)==1)
			((jbl_reference*)thi)->ptr=NULL,pl();
		jwl_http_resh_free(thi);
		thi=ttt;
	}	
	if((jbl_gc_refcnt(thi)<=1)){if(pthi)*pthi=thi;return this;}

	jwl_http_resh * tmp=jwl_http_resh_new();
	tmp->status			=this->status;
	tmp->cache			=this->cache;
	tmp->charset		=this->charset;
	tmp->cache_max_age	=this->cache_max_age;
	tmp->content_type	=jbl_string_copy(this->content_type);
	tmp->etag			=jbl_string_copy(this->etag);
	tmp->v				=jbl_ht_copy(this->v);
	
	jwl_http_resh_free(this);
	if(ref)		ref->ptr=tmp;
	else		this=tmp;
	if(pthi)	*pthi=tmp;	
	return this;
}
jbl_string* jwl_http_resh_encode(jbl_string *buf,jwl_http_resh *head,jbl_string_size_type size)
{
#define rn() buf=jbl_string_add_char(jbl_string_add_char(buf,'\r'),'\n')
	if(!head)return buf;
	head=jbl_refer_pull(head);
	buf=jbl_string_extend(buf,JWL_HTTP_MAX_HEADER_LENGTH);
	buf=jbl_string_add_chars(buf,UC"HTTP/1.1 ");
	buf=jbl_string_add_uint64(buf,head->status);
	switch(head->status)
	{
		case 200:
			buf=jbl_string_add_chars(buf,UC" OK");
			break;
		case 304:
			buf=jbl_string_add_chars(buf,UC" Not Modified");
			break;
	}
	rn();
	buf=jbl_string_add_chars(buf,UC"Server: "JWL_HTTP_RESPONSE_SERVER_NAME)															,rn();
	buf=jbl_string_add_chars(buf,UC"Content-Length: ")						,buf=jbl_string_add_uint64(buf,size)					,rn();
	buf=jbl_string_add_chars(buf,UC"Accept-Ranges: bytes")																			,rn();
	if(head->cache==JWL_HTTP_CACHE_MAX_AGE)
		buf=jbl_string_add_chars(buf,UC"Cache-Control:public, max-age=")	,buf=jbl_string_add_uint64(buf,head->cache_max_age)		,rn();
	else
	{
		buf=jbl_string_add_chars(buf,UC"Pragma: no-cache")																			,rn();
		buf=jbl_string_add_chars(buf,UC"Cache-Control: no-cache")																	,rn();
	}
	if(head->content_type)
	{
		buf=jbl_string_add_chars(buf,UC"Content-Type: ")					,buf=jbl_string_add_string(buf,head->content_type);
		char *charset[]={"","UTF-8"};
		if(head->charset)
			buf=jbl_string_add_chars(buf,UC"; charset=")					,buf=jbl_string_add_chars(buf,UC charset[head->charset]);
		rn();
	}
	if(head->etag)
		buf=jbl_string_add_chars(buf,UC"ETag: ")							,buf=jbl_string_add_string(buf,head->etag)				,rn();
	if(head->v)
		jbl_ht_foreach(head->v,i)
		{
			buf=jbl_string_add_string(buf,jbl_htk(i));
			buf=jbl_string_add_chars(buf,UC": ");
//			buf=jbl_string_add_var(&buf,jbl_htv(i));
			rn();
		}
	
	
//	buf=jbl_string_add_chars(buf,UC"Connection: keep-alive");rn();
//	buf=jbl_string_add_chars(buf,UC"Keep-Alive: timeout=4");rn();
//	buf=jbl_string_add_chars(buf,UC"Date: Thu, 11 Jun 2020 15:10:18 GMT");rn();
//	buf=jbl_string_add_chars(buf,UC"Expires: Thu, 11 Jun 2020 15:10:18 GMT");rn();
//	buf=jbl_string_add_chars(buf,UC"Proxy-Connection: keep-alive");rn();
	
	rn();
#undef rn
	return buf;
}
jwl_socket* jwl_http_send_res(jwl_socket *sock,jwl_http_resh *head,jbl_string *data)
{
	jbl_string *buf=jwl_http_resh_encode(NULL,head,jbl_string_get_length(data));
	sock=jwl_socket_send(sock,buf);
	buf=jbl_string_free(buf);
	sock=jwl_socket_send(sock,data);
	return sock;
}

jwl_http_resh * jwl_http_resh_set_status			(jwl_http_resh * this,jbl_uint16 status)			{jwl_http_resh *thi;this=jwl_http_resh_extend(this,&thi);thi->status=status;return this;}
jwl_http_resh * jwl_http_resh_set_cache				(jwl_http_resh * this,jbl_uint16 cache)				{jwl_http_resh *thi;this=jwl_http_resh_extend(this,&thi);thi->cache=cache  ;return this;}
jwl_http_resh * jwl_http_resh_set_charset			(jwl_http_resh * this,jbl_uint16 charset)			{jwl_http_resh *thi;this=jwl_http_resh_extend(this,&thi);thi->charset=charset  ;return this;}
jwl_http_resh * jwl_http_resh_set_cache_max_age		(jwl_http_resh * this,jbl_uint32 cache_max_age)		{jwl_http_resh *thi;this=jwl_http_resh_extend(this,&thi);thi->cache_max_age=cache_max_age;return this;}
jwl_http_resh * jwl_http_resh_set_content_type		(jwl_http_resh * this,jbl_string * content_type)	{jwl_http_resh *thi;this=jwl_http_resh_extend(this,&thi);jbl_string_free(thi->content_type);thi->content_type=(content_type);return this;}
jwl_http_resh * jwl_http_resh_set_etag				(jwl_http_resh * this,jbl_string * etag)			{jwl_http_resh *thi;this=jwl_http_resh_extend(this,&thi);jbl_string_free(thi->etag);thi->etag=(etag);return this;}
//jwl_http_resh * jwl_http_resh_set					(jwl_http_resh * this,jbl_string * k, jbl_var *v);
#if JBL_STREAM_ENABLE==1
void jwl_http_resh_view_put(const jwl_http_resh* this,jbl_stream *out,jbl_int32 format,char*str,jbl_int32 tabs)
{
	if(jbl_stream_view_put_format(this=jbl_refer_pull(this),out,"jwl_http_resh ",format,str,&tabs))return;
	if(format){jbl_stream_push_char(out,'\n');for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"status       :"),jbl_stream_push_uint(out,this->status)				,jbl_stream_push_char(out,'\n');
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"cache        :"),jbl_stream_push_uint(out,this->cache)					,jbl_stream_push_char(out,'\t');
	if(this->cache==JWL_HTTP_CACHE_MAX_AGE)
		jbl_stream_push_chars(out,UC"(max-age,"),jbl_stream_push_uint(out,this->cache_max_age)			,jbl_stream_push_chars(out,UC")\n");
	else
		jbl_stream_push_chars(out,UC"(no-cache)\n");
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"content type :"),jbl_stream_push_string(out,this->content_type)		,jbl_stream_push_char(out,'\n');
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	char *charset[]={"","UTF-8"};
	jbl_stream_push_chars(out,UC"charset      :"),jbl_stream_push_chars(out,UC charset[this->charset])	,jbl_stream_push_char(out,'\n');
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}//格式化的\t和\n
	jbl_stream_push_chars(out,UC"etag         :"),jbl_stream_push_string(out,this->etag);
	if(this->v)jbl_ht_foreach(this->v,i)
	{
		if(format){jbl_stream_push_char(out,'\n');for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}//格式化的\t和\n
		jbl_stream_push_char(out,'"'),jbl_stream_push_string(out,i->k),jbl_stream_push_char(out,'"');
		jbl_stream_push_char(out,':');
		jbl_var_view_put(i->v,out,(format?(-1):0),NULL,-tabs);
	}	
}
#endif




// GET / HTTP/1.1
// Host: test0.juruoyun.top:1217
// User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36
// Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
// Accept-Encoding: gzip, deflate
// Accept-Language: zh-CN,zh;q=0.9
// Cache-Control: max-age=0
// Cookie: id=1; code=7FRWuMuuKnotkD2S4qqydnMwQrEJV4HykR0bmmjpfx41ChsWdw4540709f5c6c74b70576c38cf7f7608d55b974d6625187f24fe780700e42bd57
// Upgrade-Insecure-Requests: 1


// HTTP/1.1 200 OK
// Content-Length: 10054
// Cache-Control: no-store, no-cache, must-revalidate
// Connection: keep-alive
// Content-Encoding: gzip
// Content-Type: text/html; charset=UTF-8
// Date: Thu, 11 Jun 2020 15:10:18 GMT
// Expires: Thu, 19 Nov 1981 08:52:00 GMT
// Keep-Alive: timeout=4
// Pragma: no-cache
// Proxy-Connection: keep-alive
// Server: Apache/2.4.29 (Ubuntu)
// Vary: Accept-Encoding

jwl_http_reqh *jwl_http_reqh_new()
{
	return jwl_http_reqh_init(jbl_malloc(sizeof(jwl_http_reqh)));
}
jwl_http_reqh *jwl_http_reqh_init(jwl_http_reqh * this)
{
	if(!this)jbl_exception("NULL POINTER");		
	jbl_gc_init(this);
	jbl_gc_plus(this);
	this->method		=0;
	this->protocol		=0;
	this->connection	=0;
	this->cache			=0;
	this->cache_max_age	=0;	
//jbl_string	
	this->url		=NULL;
	this->host		=NULL;
	this->ua		=NULL;
	this->referer	=NULL;
	this->etag		=NULL;
//jbl_ht
	this->cookie	=NULL;
	this->v			=NULL;
	return this;
}
jwl_http_reqh *jwl_http_reqh_free(jwl_http_reqh * this)
{
	if(!this)return NULL;
	jbl_gc_minus(this);
	if(!jbl_gc_refcnt(this))
	{
		if(jbl_gc_is_ref(this))
			jwl_http_reqh_free((jwl_http_reqh *)jbl_refer_pull(this));
		else
		{
			this->url		=jbl_string_free(this->url);
			this->host		=jbl_string_free(this->host);
			this->ua		=jbl_string_free(this->ua);
			this->referer	=jbl_string_free(this->referer);
			this->etag		=jbl_string_free(this->etag);
			
			this->v			=jbl_ht_free	(this->v);
			this->cookie	=jbl_ht_free	(this->v);
		}
		if(jbl_gc_is_var(this))//因为该功能依赖jbl_ht,jbl_ht强制依赖var所以不用宏判断
			jbl_free((char*)this-sizeof(jbl_var));
		else
			jbl_free(this);
	}
	return NULL;	
	
}
inline jwl_http_reqh *jwl_http_reqh_extend(jwl_http_reqh * this,jwl_http_reqh **pthi)
{
	if(!this){this=jwl_http_reqh_new();if(pthi)*pthi=this;return this;}
	jbl_reference *ref=NULL;jwl_http_reqh *thi=jbl_refer_pull_keep_father(this,&ref);
	if(jbl_gc_is_pvar(thi))
	{
		jwl_http_reqh *ttt=((jbl_reference*)thi)->ptr;
		if(jbl_gc_refcnt(thi)==1)
			((jbl_reference*)thi)->ptr=NULL,pl();
		jwl_http_reqh_free(thi);
		thi=ttt;
	}	
	if((jbl_gc_refcnt(thi)<=1)){if(pthi)*pthi=thi;return this;}

	jwl_http_reqh * tmp=jwl_http_reqh_new();
	tmp->method			=this->method;
	tmp->protocol		=this->protocol;
	tmp->connection		=this->connection;
	tmp->cache			=this->cache;
	tmp->cache_max_age	=this->cache_max_age;
	
	tmp->url		=jbl_string_copy(this->url);
	tmp->host		=jbl_string_copy(this->host);
	tmp->ua			=jbl_string_copy(this->ua);
	tmp->referer	=jbl_string_copy(this->referer);
	tmp->etag		=jbl_string_copy(this->etag);
	
	tmp->cookie		=jbl_ht_copy(this->cookie);
	tmp->v			=jbl_ht_copy(this->v);
	
	jwl_http_reqh_free(this);
	if(ref)		ref->ptr=tmp;
	else		this=tmp;
	if(pthi)	*pthi=tmp;	
	return this;
}
jry_wb_http_key __jry_wb_http_rqhd_scanner(unsigned char * YYCURSOR,unsigned char * YYLIMIT,unsigned char **addr)
{
	unsigned char *		YYMARKER;
	#define YYCTYPE		unsigned char
	#define YYFILL(n)	return 0;
    
#line 314 "jwl/jwl_http.c"
{
	YYCTYPE yych;
	if ((YYLIMIT - YYCURSOR) < 17) YYFILL(17);
	yych = *YYCURSOR;
	switch (yych) {
	case '\r':	goto yy4;
	case 'A':	goto yy5;
	case 'C':	goto yy6;
	case 'E':	goto yy7;
	case 'H':	goto yy8;
	case 'I':	goto yy9;
	case 'R':	goto yy10;
	case 'U':	goto yy11;
	default:	goto yy2;
	}
yy2:
	++YYCURSOR;
yy3:
#line 311 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_UNDEFINED;}
#line 335 "jwl/jwl_http.c"
yy4:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case '\n':	goto yy12;
	default:	goto yy3;
	}
yy5:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case 'c':	goto yy14;
	default:	goto yy3;
	}
yy6:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case 'a':	goto yy15;
	case 'o':	goto yy16;
	default:	goto yy3;
	}
yy7:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case 't':	goto yy17;
	default:	goto yy3;
	}
yy8:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case 'o':	goto yy18;
	default:	goto yy3;
	}
yy9:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case 'f':	goto yy19;
	default:	goto yy3;
	}
yy10:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case 'e':	goto yy20;
	default:	goto yy3;
	}
yy11:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case 's':	goto yy21;
	default:	goto yy3;
	}
yy12:
	yych = *++YYCURSOR;
	switch (yych) {
	case '\r':	goto yy22;
	default:	goto yy13;
	}
yy13:
	YYCURSOR = YYMARKER;
	goto yy3;
yy14:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'c':	goto yy23;
	default:	goto yy13;
	}
yy15:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'c':	goto yy24;
	default:	goto yy13;
	}
yy16:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'o':	goto yy25;
	default:	goto yy13;
	}
yy17:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'a':	goto yy26;
	default:	goto yy13;
	}
yy18:
	yych = *++YYCURSOR;
	switch (yych) {
	case 's':	goto yy27;
	default:	goto yy13;
	}
yy19:
	yych = *++YYCURSOR;
	switch (yych) {
	case '-':	goto yy28;
	default:	goto yy13;
	}
yy20:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'f':	goto yy29;
	default:	goto yy13;
	}
yy21:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'e':	goto yy30;
	default:	goto yy13;
	}
yy22:
	yych = *++YYCURSOR;
	switch (yych) {
	case '\n':	goto yy31;
	default:	goto yy13;
	}
yy23:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'e':	goto yy33;
	default:	goto yy13;
	}
yy24:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'h':	goto yy34;
	default:	goto yy13;
	}
yy25:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'k':	goto yy35;
	default:	goto yy13;
	}
yy26:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'g':	goto yy36;
	default:	goto yy13;
	}
yy27:
	yych = *++YYCURSOR;
	switch (yych) {
	case 't':	goto yy37;
	default:	goto yy13;
	}
yy28:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'N':	goto yy38;
	default:	goto yy13;
	}
yy29:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'e':	goto yy39;
	default:	goto yy13;
	}
yy30:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'r':	goto yy40;
	default:	goto yy13;
	}
yy31:
	++YYCURSOR;
#line 312 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_FINISH;}
#line 500 "jwl/jwl_http.c"
yy33:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'p':	goto yy41;
	default:	goto yy13;
	}
yy34:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'e':	goto yy42;
	default:	goto yy13;
	}
yy35:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'i':	goto yy43;
	default:	goto yy13;
	}
yy36:
	yych = *++YYCURSOR;
	switch (yych) {
	case ':':	goto yy44;
	default:	goto yy13;
	}
yy37:
	yych = *++YYCURSOR;
	switch (yych) {
	case ':':	goto yy45;
	default:	goto yy13;
	}
yy38:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'o':	goto yy46;
	default:	goto yy13;
	}
yy39:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'r':	goto yy47;
	default:	goto yy13;
	}
yy40:
	yych = *++YYCURSOR;
	switch (yych) {
	case '-':	goto yy48;
	default:	goto yy13;
	}
yy41:
	yych = *++YYCURSOR;
	switch (yych) {
	case 't':	goto yy49;
	default:	goto yy13;
	}
yy42:
	yych = *++YYCURSOR;
	switch (yych) {
	case '-':	goto yy50;
	default:	goto yy13;
	}
yy43:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'e':	goto yy51;
	default:	goto yy13;
	}
yy44:
	yych = *++YYCURSOR;
	switch (yych) {
	case ' ':	goto yy52;
	default:	goto yy13;
	}
yy45:
	yych = *++YYCURSOR;
	switch (yych) {
	case ' ':	goto yy54;
	default:	goto yy13;
	}
yy46:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'n':	goto yy56;
	default:	goto yy13;
	}
yy47:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'e':	goto yy57;
	default:	goto yy13;
	}
yy48:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'A':	goto yy58;
	default:	goto yy13;
	}
yy49:
	yych = *++YYCURSOR;
	switch (yych) {
	case '-':	goto yy59;
	case ':':	goto yy60;
	default:	goto yy13;
	}
yy50:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'C':	goto yy61;
	default:	goto yy13;
	}
yy51:
	yych = *++YYCURSOR;
	switch (yych) {
	case ':':	goto yy62;
	default:	goto yy13;
	}
yy52:
	++YYCURSOR;
#line 321 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_ETAG;}
#line 620 "jwl/jwl_http.c"
yy54:
	++YYCURSOR;
#line 313 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_HOST;}
#line 625 "jwl/jwl_http.c"
yy56:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'e':	goto yy63;
	default:	goto yy13;
	}
yy57:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'r':	goto yy64;
	default:	goto yy13;
	}
yy58:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'g':	goto yy65;
	default:	goto yy13;
	}
yy59:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'E':	goto yy66;
	case 'L':	goto yy67;
	default:	goto yy13;
	}
yy60:
	yych = *++YYCURSOR;
	switch (yych) {
	case ' ':	goto yy68;
	default:	goto yy13;
	}
yy61:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'o':	goto yy70;
	default:	goto yy13;
	}
yy62:
	yych = *++YYCURSOR;
	switch (yych) {
	case ' ':	goto yy71;
	default:	goto yy13;
	}
yy63:
	yych = *++YYCURSOR;
	switch (yych) {
	case '-':	goto yy73;
	default:	goto yy13;
	}
yy64:
	yych = *++YYCURSOR;
	switch (yych) {
	case ':':	goto yy74;
	default:	goto yy13;
	}
yy65:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'e':	goto yy75;
	default:	goto yy13;
	}
yy66:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'n':	goto yy76;
	default:	goto yy13;
	}
yy67:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'a':	goto yy77;
	default:	goto yy13;
	}
yy68:
	++YYCURSOR;
#line 315 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_ACCEPT;}
#line 703 "jwl/jwl_http.c"
yy70:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'n':	goto yy78;
	default:	goto yy13;
	}
yy71:
	++YYCURSOR;
#line 319 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_CACHE_CONTROL;}
#line 714 "jwl/jwl_http.c"
yy73:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'M':	goto yy79;
	default:	goto yy13;
	}
yy74:
	yych = *++YYCURSOR;
	switch (yych) {
	case ' ':	goto yy80;
	default:	goto yy13;
	}
yy75:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'n':	goto yy82;
	default:	goto yy13;
	}
yy76:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'c':	goto yy83;
	default:	goto yy13;
	}
yy77:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'n':	goto yy84;
	default:	goto yy13;
	}
yy78:
	yych = *++YYCURSOR;
	switch (yych) {
	case 't':	goto yy85;
	default:	goto yy13;
	}
yy79:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'a':	goto yy86;
	default:	goto yy13;
	}
yy80:
	++YYCURSOR;
#line 320 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_REFERER;}
#line 761 "jwl/jwl_http.c"
yy82:
	yych = *++YYCURSOR;
	switch (yych) {
	case 't':	goto yy87;
	default:	goto yy13;
	}
yy83:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'o':	goto yy88;
	default:	goto yy13;
	}
yy84:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'g':	goto yy89;
	default:	goto yy13;
	}
yy85:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'r':	goto yy90;
	default:	goto yy13;
	}
yy86:
	yych = *++YYCURSOR;
	switch (yych) {
	case 't':	goto yy91;
	default:	goto yy13;
	}
yy87:
	yych = *++YYCURSOR;
	switch (yych) {
	case ':':	goto yy92;
	default:	goto yy13;
	}
yy88:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'd':	goto yy93;
	default:	goto yy13;
	}
yy89:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'u':	goto yy94;
	default:	goto yy13;
	}
yy90:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'o':	goto yy95;
	default:	goto yy13;
	}
yy91:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'c':	goto yy96;
	default:	goto yy13;
	}
yy92:
	yych = *++YYCURSOR;
	switch (yych) {
	case ' ':	goto yy97;
	default:	goto yy13;
	}
yy93:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'i':	goto yy99;
	default:	goto yy13;
	}
yy94:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'a':	goto yy100;
	default:	goto yy13;
	}
yy95:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'l':	goto yy101;
	default:	goto yy13;
	}
yy96:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'h':	goto yy102;
	default:	goto yy13;
	}
yy97:
	++YYCURSOR;
#line 314 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_UA;}
#line 856 "jwl/jwl_http.c"
yy99:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'n':	goto yy103;
	default:	goto yy13;
	}
yy100:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'g':	goto yy104;
	default:	goto yy13;
	}
yy101:
	yych = *++YYCURSOR;
	switch (yych) {
	case ':':	goto yy105;
	default:	goto yy13;
	}
yy102:
	yych = *++YYCURSOR;
	switch (yych) {
	case ':':	goto yy106;
	default:	goto yy13;
	}
yy103:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'g':	goto yy107;
	default:	goto yy13;
	}
yy104:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'e':	goto yy108;
	default:	goto yy13;
	}
yy105:
	yych = *++YYCURSOR;
	switch (yych) {
	case ' ':	goto yy109;
	default:	goto yy13;
	}
yy106:
	yych = *++YYCURSOR;
	switch (yych) {
	case ' ':	goto yy111;
	default:	goto yy13;
	}
yy107:
	yych = *++YYCURSOR;
	switch (yych) {
	case ':':	goto yy113;
	default:	goto yy13;
	}
yy108:
	yych = *++YYCURSOR;
	switch (yych) {
	case ':':	goto yy114;
	default:	goto yy13;
	}
yy109:
	++YYCURSOR;
#line 318 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_CACHE_CONTROL;}
#line 921 "jwl/jwl_http.c"
yy111:
	++YYCURSOR;
#line 322 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_ETAG;}
#line 926 "jwl/jwl_http.c"
yy113:
	yych = *++YYCURSOR;
	switch (yych) {
	case ' ':	goto yy115;
	default:	goto yy13;
	}
yy114:
	yych = *++YYCURSOR;
	switch (yych) {
	case ' ':	goto yy117;
	default:	goto yy13;
	}
yy115:
	++YYCURSOR;
#line 316 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_ACCEPT_ENCODING;}
#line 943 "jwl/jwl_http.c"
yy117:
	++YYCURSOR;
#line 317 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JRY_WB_HTTP_KEY_ACCEPT_LANGUAGE;}
#line 948 "jwl/jwl_http.c"
}
#line 323 "jwl/jwl_http.l"

}
jry_wb_http_method __jry_wb_http_method_scanner(unsigned char * YYCURSOR,unsigned char * YYLIMIT,unsigned char **addr)
{
	unsigned char *		YYMARKER;
	#define YYCTYPE		unsigned char
	#define YYFILL(n)	return 0;
    
#line 959 "jwl/jwl_http.c"
{
	YYCTYPE yych;
	if ((YYLIMIT - YYCURSOR) < 4) YYFILL(4);
	yych = *YYCURSOR;
	switch (yych) {
	case 'G':	goto yy123;
	case 'P':	goto yy124;
	default:	goto yy121;
	}
yy121:
	++YYCURSOR;
yy122:
#line 331 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JWL_HTTP_METHOD_UNKNOW;}
#line 974 "jwl/jwl_http.c"
yy123:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case 'E':	goto yy125;
	default:	goto yy122;
	}
yy124:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case 'O':	goto yy127;
	default:	goto yy122;
	}
yy125:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'T':	goto yy128;
	default:	goto yy126;
	}
yy126:
	YYCURSOR = YYMARKER;
	goto yy122;
yy127:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'S':	goto yy130;
	default:	goto yy126;
	}
yy128:
	++YYCURSOR;
#line 333 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JWL_HTTP_METHOD_GET;}
#line 1006 "jwl/jwl_http.c"
yy130:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'T':	goto yy131;
	default:	goto yy126;
	}
yy131:
	++YYCURSOR;
#line 332 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JWL_HTTP_METHOD_POST;}
#line 1017 "jwl/jwl_http.c"
}
#line 334 "jwl/jwl_http.l"

}
jry_wb_http_method __jry_wb_http_protocol_scanner(unsigned char * YYCURSOR,unsigned char * YYLIMIT,unsigned char **addr)
{
	unsigned char *		YYMARKER;
	#define YYCTYPE		unsigned char
	#define YYFILL(n)	return 0;
    
#line 1028 "jwl/jwl_http.c"
{
	YYCTYPE yych;
	if ((YYLIMIT - YYCURSOR) < 8) YYFILL(8);
	yych = *YYCURSOR;
	switch (yych) {
	case 'H':	goto yy137;
	default:	goto yy135;
	}
yy135:
	++YYCURSOR;
yy136:
#line 342 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JWL_HTTP_PROTOCOL_UNKNOW;}
#line 1042 "jwl/jwl_http.c"
yy137:
	yych = *(YYMARKER = ++YYCURSOR);
	switch (yych) {
	case 'T':	goto yy138;
	default:	goto yy136;
	}
yy138:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'T':	goto yy140;
	default:	goto yy139;
	}
yy139:
	YYCURSOR = YYMARKER;
	goto yy136;
yy140:
	yych = *++YYCURSOR;
	switch (yych) {
	case 'P':	goto yy141;
	default:	goto yy139;
	}
yy141:
	yych = *++YYCURSOR;
	switch (yych) {
	case '/':	goto yy142;
	default:	goto yy139;
	}
yy142:
	yych = *++YYCURSOR;
	switch (yych) {
	case '1':	goto yy143;
	default:	goto yy139;
	}
yy143:
	yych = *++YYCURSOR;
	switch (yych) {
	case '.':	goto yy144;
	default:	goto yy139;
	}
yy144:
	yych = *++YYCURSOR;
	switch (yych) {
	case '1':	goto yy145;
	default:	goto yy139;
	}
yy145:
	++YYCURSOR;
#line 343 "jwl/jwl_http.l"
	{if(addr)*addr=YYCURSOR;return JWL_HTTP_PROTOCOL_HTTP;}
#line 1092 "jwl/jwl_http.c"
}
#line 344 "jwl/jwl_http.l"

}

jwl_http_reqh* jwl_http_reqh_decode(jbl_string *buf,jbl_string_size_type *start)
{	
	if(!buf)return NULL;
	buf=jbl_refer_pull(buf);
	jbl_string_size_type i=0;if(start)i=*start;
	unsigned char *addr;
	jwl_http_reqh * reqh=jwl_http_reqh_new();
	
	reqh->method=__jry_wb_http_method_scanner(buf->s+i,buf->s+buf->len,&addr);i=addr-buf->s;
	
	for(++i;buf->s[i]!=' ';reqh->url=jbl_string_add_char(reqh->url,buf->s[i]),++i);++i;
	
	reqh->protocol=__jry_wb_http_protocol_scanner(buf->s+i,buf->s+buf->len,&addr);i=addr-buf->s;

	for(;i<buf->len;++i)
	{
		jry_wb_http_key key=__jry_wb_http_rqhd_scanner(buf->s+i,buf->s+buf->len,&addr);
		switch(key)
		{
			case JRY_WB_HTTP_KEY_FINISH				:goto finish;																															;break;
			case JRY_WB_HTTP_KEY_UA					:for(i=addr-buf->s;i<buf->len&&buf->s[i-1]!='\r'&&buf->s[i]!='\n';reqh->ua		=jbl_string_add_char(reqh->ua		,buf->s[i]),++i)	;--reqh->ua->len		;break;
			case JRY_WB_HTTP_KEY_HOST				:for(i=addr-buf->s;i<buf->len&&buf->s[i-1]!='\r'&&buf->s[i]!='\n';reqh->host	=jbl_string_add_char(reqh->host		,buf->s[i]),++i)	;--reqh->host->len		;break;
			case JRY_WB_HTTP_KEY_REFERER			:for(i=addr-buf->s;i<buf->len&&buf->s[i-1]!='\r'&&buf->s[i]!='\n';reqh->referer	=jbl_string_add_char(reqh->referer	,buf->s[i]),++i)	;--reqh->referer->len	;break;
			case JRY_WB_HTTP_KEY_ETAG				:for(i=addr-buf->s;i<buf->len&&buf->s[i-1]!='\r'&&buf->s[i]!='\n';reqh->etag	=jbl_string_add_char(reqh->etag		,buf->s[i]),++i)	;--reqh->etag->len		;break;
			
			case JRY_WB_HTTP_KEY_COOKIE				:break;
			case JRY_WB_HTTP_KEY_ACCEPT				:break;
			case JRY_WB_HTTP_KEY_ACCEPT_ENCODING	:break;
			case JRY_WB_HTTP_KEY_ACCEPT_LANGUAGE	:break;
			case JRY_WB_HTTP_KEY_CACHE_CONTROL		:break;
			
			
			
			default:break;
		}
/*	
		for(;i<buf->len&&buf->s[i-1]!='\r'&&buf->s[i]!='\n';reqh->ua=jbl_string_add_char(reqh->ua,buf->s[i]),++i);
		
		for(j=(addr-s),k=0;j<n&&s[j-1]!='\r'&&s[j]!='\n';tmp[k]=s[j],++j,++k);k-=1;tmp[k]=0;i=j;




		{
			case JRY_WB_HTTP_KEY_HOST			:	printf("host            matched:   %s\n",tmp);break;
			case JRY_WB_HTTP_KEY_COOKIE			:	printf("cookie          matched:   %s\n",tmp);break;
			case JRY_WB_HTTP_KEY_ACCEPT			:	printf("accept          matched:   %s\n",tmp);break;
			case JRY_WB_HTTP_KEY_ACCEPT_ENCODING:	printf("accept encoding matched:   %s\n",tmp);break;
			case JRY_WB_HTTP_KEY_ACCEPT_LANGUAGE:	printf("accept language matched:   %s\n",tmp);break;
			case JRY_WB_HTTP_KEY_CACHE_CONTROL	:	printf("cache control   matched:   %s\n",tmp);break;
		}
*/
		
	}
finish:;
	if(start)*start=i;
	
	
	return reqh;
}








#if JBL_STREAM_ENABLE==1
void jwl_http_reqh_view_put(const jwl_http_reqh* this,jbl_stream *out,jbl_int32 format,char*str,jbl_int32 tabs)
{
	if(jbl_stream_view_put_format(this=jbl_refer_pull(this),out,"jwl_http_reqh ",format,str,&tabs))return;
	if(format){jbl_stream_push_char(out,'\n');for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	char * method[]={"unknow","get","post"};
	char * protocol[]={"unknow","HTTP"};
	jbl_stream_push_chars(out,UC"method       :"),jbl_stream_push_chars(out,UC method[this->method])	,jbl_stream_push_char(out,'\n');	
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"url          :"),jbl_stream_push_string(out,this->url)					,jbl_stream_push_char(out,'\n');	
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"protocol     :"),jbl_stream_push_chars(out,UC protocol[this->protocol]),jbl_stream_push_char(out,'\n');	
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"user agent   :"),jbl_stream_push_string(out,this->ua)					,jbl_stream_push_char(out,'\n');	
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"host         :"),jbl_stream_push_string(out,this->host)				,jbl_stream_push_char(out,'\n');	
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"referer      :"),jbl_stream_push_string(out,this->referer)				,jbl_stream_push_char(out,'\n');	
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"etag         :"),jbl_stream_push_string(out,this->etag)				,jbl_stream_push_char(out,'\n');	
/*
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"cache        :"),jbl_stream_push_uint(out,this->cache),jbl_stream_push_char(out,'\t');
	if(this->cache==JWL_HTTP_CACHE_MAX_AGE)
		jbl_stream_push_chars(out,UC"(max-age,"),jbl_stream_push_uint(out,this->cache_max_age),jbl_stream_push_chars(out,UC")\n");
	else
		jbl_stream_push_chars(out,UC"(no-cache)\n");
	jbl_stream_push_chars(out,UC"content type :"),jbl_stream_push_string(out,this->content_type),jbl_stream_push_char(out,'\n');
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}
	jbl_stream_push_chars(out,UC"charset      :");
	switch(this->charset)
	{
		case JWL_HTTP_CHARSET_UTF8:jbl_stream_push_chars(out,UC"UTF-8");break;
	}	
	jbl_stream_push_char(out,'\n');
	if(format){for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}//格式化的\t和\n
	jbl_stream_push_chars(out,UC"etag         :"),jbl_stream_push_string(out,this->etag);
	if(this->v)jbl_ht_foreach(this->v,i)
	{
		if(format){jbl_stream_push_char(out,'\n');for(jbl_int32 i=0;i<tabs;jbl_stream_push_char(out,'\t'),++i);}//格式化的\t和\n
		jbl_stream_push_char(out,'"'),jbl_stream_push_string(out,i->k),jbl_stream_push_char(out,'"');
		jbl_stream_push_char(out,':');
		jbl_var_view_put(i->v,out,(format?(-1):0),NULL,-tabs);
	}
*/	
}
#endif

/*
#define sg(x,y)	jbl_string_get2(x,y)
#define _(x)	this->status=0;	\
				this->cache=0;\
				this->cache_max_age=0;\
				jbl_string_##x(&this->content_type);\
				jbl_string_##x(&this->etag);\
				jbl_hash_table_##x(&this->v);
inline void jwl_http_response_head_init(jwl_http_response_head *this){_(init);}
inline void jwl_http_response_head_free(jwl_http_response_head *this){_(free);}
inline void jwl_http_response_head_clear(jwl_http_response_head *this){_(clear);}
#undef _
#define _(x)	this->method=0;	\
				this->protocol=0;\
				this->connection=0;\
				this->cache=0;\
				this->cache_max_age=0;\
				jbl_string_##x(&this->url);\
				jbl_string_##x(&this->host);\
				jbl_string_##x(&this->ua);\
				jbl_string_##x(&this->referer);\
				jbl_string_##x(&this->etag);\
				jbl_hash_table_##x(&this->cookie);\
				jbl_hash_table_##x(&this->v);
inline void jwl_http_request_head_init(jwl_http_request_head *this){_(init);}
inline void jwl_http_request_head_free(jwl_http_request_head *this){_(free);}
inline void jwl_http_request_head_clear(jwl_http_request_head *this){_(clear);}
#undef _
void jwl_http_send_response_head(jbl_socket_handle *client,jwl_http_response_head *head,jbl_string *data)
{
#define rn() jbl_string_add_char1(&buf,'\r'),jbl_string_add_char1(&buf,'\n')
	if(client==NULL||head==NULL||data==NULL)jbl_exception(JBL_ERROR_NULL_POINTER);	
	jbl_string buf;jbl_string_init(&buf);jbl_string_extend_to(&buf,JWL_HTTP_MAX_HEADER_LENGTH);
	jbl_string_add_chars(&buf,"HTTP/1.1 ");
	jbl_string_add_uint64(&buf,head->status);
	switch(head->status)
	{
		case 200:
			jbl_string_add_chars(&buf," OK");
			break;
		case 304:
			jbl_string_add_chars(&buf," Not Modified");
			break;
	}
	rn();
	jbl_string_add_chars(&buf,"Server:"JWL_HTTP_RESPONSE_SERVER_NAME"\r\n");
	jbl_string_add_chars(&buf,"Accept-Ranges: bytes\r\n");
	jbl_string_add_chars(&buf,"Content-Length: ");jbl_string_add_uint64(&buf,jbl_string_get_length(data));rn();
	jbl_string_add_chars(&buf,"Connection: close\r\n");
	jbl_string_add_chars(&buf,"Expires: Sat, 26 Jul 1997 05:00:00 GMT\r\n");
	jbl_string_add_chars(&buf,"Content-Type: ");jbl_string_add_string(&buf,&head->content_type);rn();
	jbl_string_add_chars(&buf,"ETag: ");jbl_string_add_string(&buf,&head->etag);rn();
	jbl_string_add_chars(&buf,"Cache-Control: public, ");if(head->cache==JWL_HTTP_CACHE_MAX_AGE)jbl_string_add_chars(&buf,"max-age="),jbl_string_add_uint64(&buf,head->cache_max_age);else jbl_string_add_chars(&buf,"no-cache");rn();
	jbl_hash_table_foreach(&head->v,i)
	{
		jbl_string_add_string(&buf,jbl_hash_table_get_key(i));
		jbl_string_add_char1(&buf,':');jbl_string_add_char1(&buf,' ');
		jbl_string_add_var(&buf,jbl_hash_table_get_var(i));
		rn();
	}	
	rn();
	jwl_socket_send(client,&buf);
	jbl_string_free(&buf);
#undef rn
}
void jwl_http_send_response(jbl_socket_handle *client,jwl_http_response_head *head,jbl_string *data)
{
	if(client==NULL||head==NULL||data==NULL)jbl_exception(JBL_ERROR_NULL_POINTER);	
	jwl_http_send_response_head(client,head,data);
	jwl_socket_send(client,data);
}

jbl_uint8 jwl_http_get_request_head(jbl_socket_handle *client,jwl_http_request_head *head,jbl_string *remain_data)
{
	if(client==NULL||head==NULL||remain_data==NULL)jbl_exception(JBL_ERROR_NULL_POINTER);	
	jbl_string tmp1,tmp2,tmp3,tmp4,tmp5;jbl_string_init(&tmp1);jbl_string_init(&tmp2);jbl_string_init(&tmp3);jbl_string_init(&tmp4);jbl_string_init(&tmp5);
	jwl_socket_receive_length(client,&tmp1,JWL_HTTP_MAX_HEADER_LENGTH);
	jbl_string_size_type i=0,n=jbl_string_get_length(&tmp1),j,ii;
	jbl_uint8 flag=(n==JWL_HTTP_MAX_HEADER_LENGTH);
	static const jbl_string cn=jbl_string_const("Connection"			,10);
	static const jbl_string ua=jbl_string_const("User-Agent"			,10);
	static const jbl_string ho=jbl_string_const("Host"				,4);
	static const jbl_string re=jbl_string_const("Referer"				,7);
	static const jbl_string pr=jbl_string_const("Pragma"				,6);
	static const jbl_string cc=jbl_string_const("Cache-Control"		,13);
	static const jbl_string co=jbl_string_const("Cookie"				,6);
	static const jbl_string et=jbl_string_const("ETag"				,4);
	static const jbl_string nm=jbl_string_const("If-None-Match"		,13);
	static const jbl_string or=jbl_string_const("Origin"				,6);
	
	static const jbl_string ac=jbl_string_const("Accept"				,6);
	static const jbl_string ae=jbl_string_const("Accept-Encoding"		,15);
	static const jbl_string al=jbl_string_const("Accept-Language"		,15);
	static const jbl_string uir=jbl_string_const("Upgrade-Insecure-Requests",25);
method_start:
	if(((i+2)<n)&&sg(&tmp1,i+0)=='G'&&sg(&tmp1,i+1)=='E'&&sg(&tmp1,i+2)=='T')
		head->method=JWL_HTTP_METHOD_GET,i+=3;
	else if(((i+3)<n)&&sg(&tmp1,i+0)=='P'&&sg(&tmp1,i+1)=='O'&&sg(&tmp1,i+2)=='S'&&sg(&tmp1,i+1)=='T')
		head->method=JWL_HTTP_METHOD_POST,i+=4;
	else
		goto fail;
	++i;
url_start:
	j=jbl_string_find_char_start(&tmp1,' ',i);
	jbl_string_equal_chars_length(&head->url,jbl_string_get_chars(&tmp1)+i,j-i);
	i=j+1;
protocol_start:
	if(((i+8)<n)&&	sg(&tmp1,i+0)=='H'&&sg(&tmp1,i+1)=='T'&&sg(&tmp1,i+2)=='T'&&sg(&tmp1,i+3)=='P'&&sg(&tmp1,i+4)=='/'&&
					sg(&tmp1,i+5)=='1'&&sg(&tmp1,i+6)=='.'&&sg(&tmp1,i+7)=='1')
		head->protocol=JWL_HTTP_PROTOCOL_HTTP,i+=8;
	else
		goto fail;
	i+=2;
value_start:
	while((i+4)<n&&(!(sg(&tmp1,i)=='\r'&&sg(&tmp1,i+1)=='\n'&&sg(&tmp1,i+2)=='\r'&&sg(&tmp1,i+3)=='\n')))
	{
		j=jbl_string_find_char_start(&tmp1,':',i);
		jbl_string_equal_chars_length(&tmp2,jbl_string_get_chars(&tmp1)+i,j-i);
		i=j+1;
		while(i<n&&(sg(&tmp1,i)==' '))++i;
		j=jbl_string_find_char_start(&tmp1,'\r',i);
		jbl_string_equal_chars_length(&tmp3,jbl_string_get_chars(&tmp1)+i,j-i);
		i=j+2;
		if(jbl_string_if_equal(&tmp2,&cn))
		{
			ii=jbl_string_get_length(&tmp3);
			if((9<ii)&&	sg(&tmp3,0)=='k'&&sg(&tmp3,1)=='e'&&sg(&tmp3,2)=='e'&&sg(&tmp3,3)=='p'&&sg(&tmp3,4)=='-'&&
						sg(&tmp3,5)=='a'&&sg(&tmp3,6)=='l'&&sg(&tmp3,7)=='i'&&sg(&tmp3,8)=='v'&&sg(&tmp3,9)=='e')
				head->connection=JWL_HTTP_CONNECTION_KEEP_ALIVE;
			else if((4<ii)&&sg(&tmp3,0)=='c'&&sg(&tmp3,1)=='l'&&sg(&tmp3,2)=='o'&&sg(&tmp3,3)=='s'&&sg(&tmp3,4)=='e')
				head->connection=JWL_HTTP_CONNECTION_CLOSE;
			else if((6<ii)&&sg(&tmp3,0)=='U'&&sg(&tmp3,1)=='p'&&sg(&tmp3,2)=='g'&&sg(&tmp3,3)=='r'&&sg(&tmp3,4)=='a'&&
							sg(&tmp3,5)=='d'&&sg(&tmp3,6)=='e')
				head->connection=JWL_HTTP_CONNECTION_UPGRADE;				
			else 
				goto fail;
		}
		else if(jbl_string_if_equal(&tmp2,&ua))
			jbl_string_equal_move(&head->ua,&tmp3);
		else if(jbl_string_if_equal(&tmp2,&ho))
			jbl_string_equal_move(&head->host,&tmp3);
		else if(jbl_string_if_equal(&tmp2,&re)||jbl_string_if_equal(&tmp2,&or))
			jbl_string_equal_move(&head->referer,&tmp3);
		else if(jbl_string_if_equal(&tmp2,&et)||jbl_string_if_equal(&tmp2,&nm))
			jbl_string_equal_move(&head->etag,&tmp3);		
		else if(jbl_string_if_equal(&tmp2,&pr)||jbl_string_if_equal(&tmp2,&cc))
		{
			ii=jbl_string_get_length(&tmp3);
			if((7<ii)&&	sg(&tmp3,0)=='n'&&sg(&tmp3,1)=='o'&&sg(&tmp3,2)=='-'&&sg(&tmp3,3)=='c'&&sg(&tmp3,4)=='a'&&
						sg(&tmp3,5)=='c'&&sg(&tmp3,6)=='h'&&sg(&tmp3,7)=='e')
				head->cache=JWL_HTTP_CACHE_NO;
			else if ((7<ii)&&	sg(&tmp3,0)=='m'&&sg(&tmp3,1)=='a'&&sg(&tmp3,2)=='x'&&sg(&tmp3,3)=='-'&&sg(&tmp3,4)=='a'&&
								sg(&tmp3,5)=='g'&&sg(&tmp3,6)=='e'&&sg(&tmp3,7)=='=')
				head->cache=JWL_HTTP_CACHE_MAX_AGE,head->cache_max_age=jbl_string_get_uint64(&tmp3);
			else 
				goto fail;			
		}	
		else if(jbl_string_if_equal(&tmp2,&co))
		{
			ii=jbl_string_get_length(&tmp3);
			jbl_var v;jbl_var_init(&v);
			for(register jbl_string_size_type i1=0,j1;i1<ii;i1++)
			{
				while(i1<ii&&(sg(&tmp3,i1)==' '))++i1;
				j1=jbl_string_find_char_start(&tmp3,'=',i1);
				jbl_string_equal_chars_length(&tmp4,jbl_string_get_chars(&tmp3)+i1,j1-i1);
				i1=j1+1;
				j1=jbl_string_find_char_start(&tmp3,';',i1);
				jbl_string_equal_chars_length(&tmp5,jbl_string_get_chars(&tmp3)+i1,j1-i1);
				i1=j1+1;
				jbl_var_equal_string(&v,&tmp5,move);
				jbl_hash_table_insert(&head->cookie,&tmp4,&v,move,move);				
			}
			jbl_var_free(&v);
		}
		else if(jbl_string_if_equal(&tmp2,&ac)||jbl_string_if_equal(&tmp2,&ae)||jbl_string_if_equal(&tmp2,&al)||jbl_string_if_equal(&tmp2,&uir)){}
		else
		{
			jbl_var v;jbl_var_init(&v);
			jbl_var_equal_string(&v,&tmp3,move);
			jbl_hash_table_insert(&head->v,&tmp2,&v,move,move);
			jbl_var_free(&v);
		}
	}
	i+=4;
	
	
	
	
	
	
	
	
	
	goto success;
fail:
	jwl_http_request_head_clear(head);
	i=0;
success:
	if(i<n)
		jbl_string_add_chars_length(remain_data,jbl_string_get_chars(&tmp1)+i,n-i);
	jbl_string_free(&tmp1);jbl_string_free(&tmp2);jbl_string_free(&tmp3);jbl_string_free(&tmp4);jbl_string_free(&tmp5);
	return flag;
}

jbl_uint8 jwl_http_send_request_head(jbl_socket_handle *client,jwl_http_request_head *head)
{
	if(client==NULL||head==NULL)jbl_exception(JBL_ERROR_NULL_POINTER);
#define rn() jbl_string_add_char1(&buf,'\r'),jbl_string_add_char1(&buf,'\n')
	jbl_string buf;jbl_string_init(&buf);jbl_string_extend_to(&buf,JWL_HTTP_MAX_HEADER_LENGTH);
	if(head->method==JWL_HTTP_METHOD_POST)				jbl_string_add_chars(&buf,"POST ");
	else if(head->method==JWL_HTTP_METHOD_GET)			jbl_string_add_chars(&buf,"GET ");
	else goto fail;
	jbl_string_add_string(&buf,&head->url);
	jbl_string_add_char1(&buf,' ');
	if(head->protocol==JWL_HTTP_PROTOCOL_HTTP)			jbl_string_add_chars(&buf,"HTTP/1.1");
	else goto fail;	
	rn();
	jbl_string_add_chars(&buf,"Connection: ");
	if(head->method==JWL_HTTP_CONNECTION_CLOSE)			jbl_string_add_chars(&buf,"close");
	else if(head->method==JWL_HTTP_CONNECTION_KEEP_ALIVE)jbl_string_add_chars(&buf,"keep-alive");
	else goto fail;	
	rn();
	jbl_string_add_chars(&buf,"Cache-Control: ");
	if(head->cache==JWL_HTTP_CACHE_NO)					jbl_string_add_chars(&buf,"no-cache");
	else if(head->cache==JWL_HTTP_CACHE_MAX_AGE)			jbl_string_add_chars(&buf,"max-age="),jbl_string_add_uint64(&buf,head->cache_max_age);
	else goto fail;
	rn();
	if(jbl_string_get_length(&head->host)>0)			jbl_string_add_chars(&buf,"Host: ")		,jbl_string_add_string(&buf,&head->host)			,rn();
	if(jbl_string_get_length(&head->ua)>0)	jbl_string_add_chars(&buf,"User-Agent: ")	,jbl_string_add_string(&buf,&head->ua)	,rn();
//	jbl_string_add_chars(&buf,"Cookie: ");jbl_string_add_string(&buf,&head->cookie);rn();
	rn();
success:
	jwl_socket_send(client,&buf);	
fail:
		
	jbl_string_free(&buf);
#undef rn
}

void jwl_request_head_view_ex(jwl_http_request_head *this,FILE * file,char*str,int a,int tabs)
{
	if(this==NULL||file==NULL||str==NULL)jbl_exception(JBL_ERROR_NULL_POINTER);
	if(tabs>=0)
		for(register int i=0;i<tabs;++i,putc('\t',file));
	else
		tabs=-tabs;
	if(a>=0)
		fprintf(file,"jbl_request_head    %s %d:",str,a);
	else
		fprintf(file,"jbl_request_head     \t:");	
	++tabs;
	putc('\n',file);
	for(register int i=0;i<tabs;++i,putc('\t',file));	fprintf(file,"method:");	
	if(this->method==JWL_HTTP_METHOD_GET)			fprintf(file,"get");
	else if(this->method==JWL_HTTP_METHOD_POST)		fprintf(file,"post");
	else												fprintf(file,"unknow");
	putc('\n',file);

	for(register int i=0;i<tabs;++i,putc('\t',file));	fprintf(file,"protocol:");
	if(this->protocol==JWL_HTTP_PROTOCOL_HTTP)		fprintf(file,"http");
	else if(this->protocol==JWL_HTTP_PROTOCOL_HTTPS)	fprintf(file,"https");
	else												fprintf(file,"unknow");
	putc('\n',file);
	
	for(register int i=0;i<tabs;++i,putc('\t',file));		fprintf(file,"connection:");
	if(this->connection==JWL_HTTP_CONNECTION_KEEP_ALIVE)	fprintf(file,"keep-alive");
	if(this->connection==JWL_HTTP_CONNECTION_UPGRADE)	fprintf(file,"upgrade");
	else													fprintf(file,"unknow");
	putc('\n',file);
	
	for(register int i=0;i<tabs;++i,putc('\t',file));		fprintf(file,"cache_control:");
	if(this->cache==JWL_HTTP_CACHE_NO)					fprintf(file,"no");
	else if(this->cache==JWL_HTTP_CACHE_MAX_AGE)			fprintf(file,"max_age:%d",this->cache_max_age);
	else													fprintf(file,"unknow");
	putc('\n',file);	
	for(register int i=0;i<tabs;++i,putc('\t',file));fprintf(file,"url:")		;jbl_string_print(&this->url,file)			;putc('\n',file);
	for(register int i=0;i<tabs;++i,putc('\t',file));fprintf(file,"host:")		;jbl_string_print(&this->host,file)			;putc('\n',file);
	for(register int i=0;i<tabs;++i,putc('\t',file));fprintf(file,"ua:");jbl_string_print(&this->ua,file)	;putc('\n',file);
	for(register int i=0;i<tabs;++i,putc('\t',file));fprintf(file,"referer:")	;jbl_string_print(&this->referer,file)		;putc('\n',file);
	for(register int i=0;i<tabs;++i,putc('\t',file));fprintf(file,"etag:")		;jbl_string_print(&this->etag,file)		;putc('\n',file);
	for(register int i=0;i<tabs;++i,putc('\t',file));fprintf(file,"cookie:\n");	
	jbl_hash_table_foreach(&this->cookie,i)
	{
		for(register int i=0;i<tabs+1;++i,putc('\t',file));	
		jbl_string_print(jbl_hash_table_get_key(i),file);
		putc(':',file);
		jbl_var_view_ex(jbl_hash_table_get_var(i),file,"",-1,-(tabs+2));
	}	
	jbl_hash_table_foreach(&this->v,i)
	{
		for(register int i=0;i<tabs;++i,putc('\t',file));	
		jbl_string_print(jbl_hash_table_get_key(i),file);
		putc(':',file);
		jbl_var_view_ex(jbl_hash_table_get_var(i),file,"",-1,-(tabs+1));
	}
	

	
}
*/
#endif
